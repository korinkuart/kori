<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gu√≠a de Menorca ¬∑ Explora por secciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f7fb;--ink:#0f172a;--muted:#64748b;--border:#e2e8f0;--panel:#fff;
      --playas:#3b82f6;--pueblos:#0ea5e9;--miradores:#2563eb;--cultura:#a16207;
      --gastro:#16a34a;--comercio:#f97316;--ninyos:#db2777;--actividades:#10b981;--fiestas:#9333ea;
      --brand:#111827; --accent:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;color:var(--ink);background:var(--bg)}
    .topbar{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);background:#fff}
    .topbar img{height:28px;width:auto}
    .topbar h1{font-size:16px;margin:0;color:#111827;font-weight:700;letter-spacing:.2px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h2{margin:0 0 6px;font-size:22px}
    p.small{margin:0 0 12px;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 12px;align-items:center}
    select,input,button{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
    button{cursor:pointer}
    .chip{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:13px;cursor:pointer}
    .chip.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn{background:var(--brand);color:#fff;border:1px solid var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .summary{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    .summary strong{font-weight:700}
    .detail{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:12px}
    .detail-grid{display:grid;grid-template-columns:1fr;gap:0}
    @media(min-width:900px){.detail-grid{grid-template-columns:420px 1fr}}
    .detail-media{min-height:220px;max-height:280px;background:#eef2f7;display:grid;place-items:center}
    .detail-media img{width:100%;height:100%;object-fit:cover}
    .detail-body{padding:16px}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid transparent;display:inline-block}
    .b-Todos{background:#e2e8f0;color:#111827;border-color:#e5e7eb}
    .b-Playas{background:color-mix(in oklab,var(--playas) 15%,white);color:var(--playas)}
    .b-Pueblos{background:color-mix(in oklab,var(--pueblos) 15%,white);color:var(--pueblos)}
    .b-Miradores{background:color-mix(in oklab,var(--miradores) 15%,white);color:var(--miradores)}
    .b-Cultura{background:color-mix(in oklab,var(--cultura) 15%,white);color:var(--cultura)}
    .b-Gastronom√≠a{background:color-mix(in oklab,var(--gastro) 15%,white);color:var(--gastro)}
    .b-Comercio{background:color-mix(in oklab,var(--comercio) 15%,white);color:var(--comercio)}
    .b-Ni√±os{background:color-mix(in oklab,var(--ninyos) 15%,white);color:var(--ninyos)}
    .b-Actividades{background:color-mix(in oklab,var(--actividades) 15%,white);color:var(--actividades)}
    .b-Fiestas{background:color-mix(in oklab,var(--fiestas) 15%,white);color:var(--fiestas)}
    .detail-title{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .detail-title h2{margin:0;font-size:20px}
    .detail-meta{color:var(--muted);font-size:13px;margin:6px 0 10px}
    .services{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-size:13px}
    .services span{background:#f1f5f9;border:1px solid var(--border);border-radius:999px;padding:4px 8px}
    .obs{margin-top:10px;font-size:13px;color:#111}
    .below{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.below{grid-template-columns:1fr 420px}}
    #map{width:100%;height:64vh;border:1px solid var(--border);border-radius:16px;background:#fff}
    .list{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;max-height:64vh;overflow:auto}
    .card{display:flex;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;margin-bottom:8px;cursor:pointer;align-items:center}
    .card:hover{box-shadow:0 1px 8px rgba(0,0,0,.06)}
    .thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border);flex:0 0 64px;background:#f3f4f6}
    .dot{font-size:18px;line-height:1}
    .title{font-weight:600}
    .muted{color:var(--muted);font-size:12px}
    .mini{display:flex;gap:8px;margin-top:6px}
    .mini a,.mini span.link{font-size:12px;background:none;border:0;color:var(--accent);text-decoration:underline;cursor:pointer}
    .controls .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .range{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
    .overlay.active{display:flex}
    .modal{background:#fff;border-radius:12px;max-width:1000px;width:100%;height:80vh;display:flex;flex-direction:column;overflow:hidden}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border)}
    .modal iframe{border:0;flex:1}
  </style>
</head>
<body>
  <div class="topbar">
    <img src="https://static-resources-elementor.mirai.com/wp-content/uploads/sites/339/Logo2024.png" alt="Flor Los Almendros" />
    <h1>Gu√≠a de Menorca</h1>
  </div>

  <div class="wrap">
    <div class="controls">
      <div id="catChips" aria-label="Secciones"></div>
      <div class="inline">
        <select id="muniSelect" title="Municipio">
          <option value="Todos">Todos los municipios</option>
          <option>Ma√≥</option><option>Ciutadella</option><option>Es Mercadal</option>
          <option>Fornells</option><option>Alaior</option><option>Sant Llu√≠s</option>
          <option>Es Migjorn Gran</option><option>Ferreries</option><option>Es Castell</option>
        </select>
        <input id="qInput" placeholder="Buscar (p. ej., Galdana, museo‚Ä¶)" />
        <button id="resetBtn" type="button">Reiniciar</button>
      </div>

      <div class="inline">
        <button id="locateBtn" class="btn" type="button">¬øQu√© hay cerca de m√≠?</button>
        <label class="range">Radio
          <input id="radiusInput" type="range" min="1" max="50" value="10" />
          <span id="radiusLabel">10 km</span>
        </label>
        <label class="range">
          <input id="sortByDistance" type="checkbox" /> Ordenar por distancia
        </label>
      </div>
    </div>

    <section class="summary" id="summary">
      <strong id="summaryTitle">Todos</strong> ¬∑
      <span id="summaryText">Vista combinada de todas las categor√≠as.</span>
    </section>

    <section class="detail" aria-live="polite">
      <div class="detail-grid">
        <div class="detail-media">
          <img id="detailImg" alt="Imagen del lugar" src="https://images.unsplash.com/photo-1526779259212-939e64788e3c?q=80&w=1200&auto=format&fit=crop" />
        </div>
        <div class="detail-body">
          <div class="detail-title">
            <h2 id="detailName">Selecciona un lugar</h2>
            <span id="detailBadge" class="badge b-Todos">Todos</span>
          </div>
          <div id="detailMeta" class="detail-meta">‚Äî</div>
          <div id="detailDesc">Haz clic en un pin del mapa (o en la lista) para ver la ficha del lugar. En Playas ver√°s adem√°s los servicios (parking, WC, duchas, socorrista‚Ä¶).</div>
          <div class="services" id="detailServices"></div>
          <div class="obs" id="detailObs"></div>
          <div class="mini">
            <a id="detailSource" href="#" target="_blank" rel="noreferrer">Fuente</a>
            <a id="detailMaps" href="#" target="_blank" rel="noreferrer">Abrir en Google Maps</a>
            <button id="seeInModal" type="button">Ver ficha aqu√≠</button>
          </div>
        </div>
      </div>
    </section>

    <section class="below">
      <div id="map" aria-label="Mapa de Menorca"></div>
      <div class="list" id="list" aria-label="Resultados"></div>
    </section>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <header>
        <strong id="overlayTitle">Ficha Google Maps</strong>
        <button type="button" onclick="document.getElementById('overlay').classList.remove('active')">Cerrar</button>
      </header>
      <iframe id="overlayFrame" src="about:blank" loading="lazy" allowfullscreen
              referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // === Ajustes de enfoque ===
    const FOCUS_ZOOM = 16;              // Zoom al seleccionar un lugar
    const SIDE_PANEL_OFFSET_X = 140;    // Desplazamiento horizontal en px para que el pin no quede bajo la columna

    function flyToWithOffset(latlng, zoom = FOCUS_ZOOM, offsetX = SIDE_PANEL_OFFSET_X, duration = 0.7){
      const targetPoint = map.project(latlng, zoom).subtract([offsetX, 0]);
      const targetLatLng = map.unproject(targetPoint, zoom);
      map.flyTo(targetLatLng, zoom, { duration });
    }

    const CATEGORY_COPY = {
      "Todos":"Vista combinada de todas las categor√≠as.",
      "Playas":"Playas accesibles y familiares, con servicios y entorno natural; comb√≠nalas con tramos del Cam√≠ de Cavalls.",
      "Pueblos":"Pueblos y ciudades con casco hist√≥rico, puertos y vida local.",
      "Miradores":"Faros y miradores para atardeceres y vistas 360¬∞.",
      "Cultura":"Talayots, fortalezas, museos y espacios culturales.",
      "Gastronom√≠a":"Productos locales (queso, sobrasada, vino, gin) y visitas gastron√≥micas.",
      "Comercio":"Mercados y artesan√≠a aut√©ntica (avarcas, cer√°mica, miel).",
      "Ni√±os":"Planes f√°ciles y seguros: fauna, naturaleza y actividades tranquilas.",
      "Actividades":"Barco, kayak, senderismo y rutas a caballo para todos los niveles.",
      "Fiestas":"Calendario tradicional de verano por municipios."
    };

    // Datos fieles al Word con coordenadas precisas. (Resumen de los que necesitabas)
    // id, name, category, municipality, lat, lng, photo, desc, obs, services?, sourceUrl, gmapQuery|gmapUrl
    const PLACES = [
      {id:"es-grau",name:"Es Grau",category:"Playas",municipality:"Ma√≥",lat:39.9460,lng:4.2760,
        photo:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa situada en pleno Parque Natural de s‚ÄôAlbufera des Grau; aguas poco profundas, segura para ni√±os.",
        obs:"Inicio de rutas del Cam√≠ de Cavalls y excursiones en kayak dentro del parque.",
        services:["‚úîÔ∏è Parking","üöª WC","‚ùå Duchas","üçπ Restauraci√≥n en el pueblo","üõü Socorrista (verano)","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Es Grau Menorca"},
      {id:"sa-mesquida",name:"Sa Mesquida",category:"Playas",municipality:"Ma√≥",lat:39.9479,lng:4.3188,
        photo:"https://images.unsplash.com/photo-1493558103817-58b2924bce98?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa amplia y natural, abierta al norte; arena dorada y aguas cristalinas.",
        obs:"Apreciada por quienes buscan naturaleza y deportes de mar.",
        services:["‚úîÔ∏è Parking"], gmapQuery:"Sa Mesquida Menorca"},
      {id:"es-canutells",name:"Es Canutells",category:"Playas",municipality:"Ma√≥/Alaior",lat:39.8775,lng:4.1915,
        photo:"https://images.unsplash.com/photo-1526779259212-939e64788e3c?q=80&w=1200&auto=format&fit=crop",
        desc:"Cala resguardada entre acantilados; arena dorada y aguas claras junto a urbanizaci√≥n.",
        obs:"Acceso sencillo desde el centro-este.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restaurante"], gmapQuery:"Es Canutells"},

      {id:"punta-prima",name:"Punta Prima",category:"Playas",municipality:"Sant Llu√≠s",lat:39.8180,lng:4.2870,
        photo:"https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa de arena blanca con vistas a la Illa de l‚ÄôAire y su faro.",
        obs:"Excelente punto para salidas en kayak o barco hacia calas cercanas.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Punta Prima Menorca"},
      {id:"binisafuller",name:"Binisafuller",category:"Playas",municipality:"Sant Llu√≠s",lat:39.8317,lng:4.2602,
        photo:"https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop",
        desc:"Cala urbana con aguas tranquilas y ambiente menorqu√≠n.",
        obs:"Ideal para combinar ba√±o con gastronom√≠a cercana.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista (verano)","‚ôø Accesible"],
        gmapQuery:"Binisafuller Playa"},
      {id:"alcaufar",name:"Cala Alcaufar",category:"Playas",municipality:"Sant Llu√≠s",lat:39.8257,lng:4.3015,
        photo:"https://images.unsplash.com/photo-1505764706515-aa95265c5abc?q=80&w=1200&auto=format&fit=crop",
        desc:"Cala en bah√≠a estrecha y alargada, con casas tradicionales de pescadores.",
        obs:"En el encantador pueblo pesquero de Alcaufar.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Bar/restaurante","‚ôø Accesible"],
        gmapQuery:"Cala Alcaufar"},
      {id:"calo-blanc",name:"Es Cal√≥ Blanc",category:"Playas",municipality:"Sant Llu√≠s",lat:39.8210,lng:4.2760,
        photo:"https://images.unsplash.com/photo-1520975922322-cf1b25c11b5d?q=80&w=1200&auto=format&fit=crop",
        desc:"Calita muy peque√±a y fotog√©nica; aguas turquesa.",
        obs:"Espacio reducido en temporada alta; llegar pronto.",
        services:["‚úîÔ∏è Parking cercano"], gmapQuery:"Es Cal√≥ Blanc"},

      {id:"son-bou",name:"Son Bou",category:"Playas",municipality:"Alaior",lat:39.9130,lng:4.0780,
        photo:"https://images.unsplash.com/photo-1493558103817-58b2924bce98?q=80&w=1200&auto=format&fit=crop",
        desc:"La playa m√°s extensa de Menorca (casi 3 km), con sistema dunar protegido.",
        obs:"Incluye bas√≠lica paleocristiana en un extremo.",
        services:["‚úîÔ∏è Parking grande","üöª WC","üöø Duchas","üè™ Tiendas","üçπ Restaurantes","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Playa de Son Bou Menorca"},
      {id:"cala-porter",name:"Cala en Porter",category:"Playas",municipality:"Alaior",lat:39.8746,lng:4.1310,
        photo:"https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa en forma de concha entre acantilados; aguas tranquilas.",
        obs:"Todos los servicios de una playa urbana.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Cala en Porter Menorca"},

      {id:"sant-tomas",name:"Sant Tom√†s",category:"Playas",municipality:"Es Migjorn Gran",lat:39.9212,lng:4.0472,
        photo:"https://images.unsplash.com/photo-1533105079780-92b9be482077?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa larga con paseo mar√≠timo y ambiente familiar.",
        obs:"Muy c√≥moda para familias; acceso f√°cil.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Playa de Santo Tom√°s Menorca"},

      {id:"cala-bosch",name:"Cala en Bosch",category:"Playas",municipality:"Ciutadella",lat:39.9340,lng:3.8420,
        photo:"https://images.unsplash.com/photo-1544551763-7ef420be2d4e?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa urbana junto al puerto deportivo; aguas tranquilas y entorno animado.",
        obs:"Buen punto de partida para excursiones en barco al sur.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üè™ Tiendas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Cala en Bosch"},
      {id:"son-xoriguer",name:"Son Xoriguer",category:"Playas",municipality:"Ciutadella",lat:39.9370,lng:3.8330,
        photo:"https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa contigua a Cala en Bosch, con buena infraestructura.",
        obs:"Preferida para deportes n√°uticos (windsurf).",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Son Xoriguer Menorca"},
      {id:"santandria",name:"Santandria",category:"Playas",municipality:"Ciutadella",lat:39.9710,lng:3.8460,
        photo:"https://images.unsplash.com/photo-1482192505345-5655af888cc4?q=80&w=1200&auto=format&fit=crop",
        desc:"Cala urbana peque√±a de aguas poco profundas y servicios b√°sicos.",
        obs:"Muy c√≥moda para familias.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Cala Santandria Menorca"},
      {id:"cala-blanca",name:"Cala Blanca",category:"Playas",municipality:"Ciutadella",lat:39.9700,lng:3.8410,
        photo:"https://images.unsplash.com/photo-1501776192650-6633a01be047?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa urbana accesible; arena blanca y ambiente relajado.",
        obs:"Puestas de sol espectaculares sobre la costa de Mallorca.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Cala Blanca Menorca"},
      {id:"en-brut",name:"Cala en Brut",category:"Playas",municipality:"Ciutadella",lat:40.0090,lng:3.8060,
        photo:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop",
        desc:"Cala sin arena, famosa por sus plataformas de roca para saltos.",
        obs:"Ic√≥nica para saltos y aguas azul intenso.",
        services:["‚úîÔ∏è Parking"], gmapQuery:"Cala en Brut"},
      {id:"en-blanes",name:"Cala en Blanes",category:"Playas",municipality:"Ciutadella",lat:40.0060,lng:3.8070,
        photo:"https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa urbana muy popular; ambiente vacacional.",
        obs:"Muy concurrida en verano.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Cala en Blanes Menorca"},
      {id:"sa-caleta",name:"Sa Caleta",category:"Playas",municipality:"Ciutadella",lat:39.9850,lng:3.8380,
        photo:"https://images.unsplash.com/photo-1493558103817-58b2924bce98?q=80&w=1200&auto=format&fit=crop",
        desc:"Peque√±a cala urbana con ambiente local.",
        obs:"Chiringuito de temporada.",
        services:["‚úîÔ∏è Parking","üöª WC","üçπ Chiringuito","‚ôø Accesible"],
        gmapQuery:"Sa Caleta Ciutadella"},
      {id:"degollador",name:"Cala Degollador (Sa Platja Gran)",category:"Playas",municipality:"Ciutadella",lat:39.9980,lng:3.8370,
        photo:"https://images.unsplash.com/photo-1470218091926-22a08a325802?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa urbana dentro del casco hist√≥rico.",
        obs:"Perfecta para combinar playa y paseo por el casco antiguo.",
        services:["‚úîÔ∏è Parking cercano","üöª WC","üçπ Restauraci√≥n","‚ôø Accesible"],
        gmapQuery:"Sa Platja Gran Ciutadella"},
      {id:"cala-morell",name:"Cala Morell",category:"Playas",municipality:"Ciutadella",lat:40.0600,lng:3.8990,
        photo:"https://images.unsplash.com/photo-1505764706515-aa95265c5abc?q=80&w=1200&auto=format&fit=crop",
        desc:"Cala rocosa muy pintoresca en entorno residencial.",
        obs:"Excelente para snorkel por su visibilidad.",
        services:["‚úîÔ∏è Parking","üçπ Restauraci√≥n cercana","‚ôø Accesible"],
        gmapQuery:"Cala Morell"},

      {id:"galdana",name:"Cala Galdana",category:"Playas",municipality:"Ferreries",lat:39.9419,lng:3.9430,
        photo:"https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop",
        desc:"Gran playa en forma de concha rodeada de pinares; tur√≠stica y familiar.",
        obs:"Muy concurrida en verano; Cam√≠ de Cavalls cercano.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üè™ Tiendas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Cala Galdana Menorca"},
      {id:"mitjana",name:"Cala Mitjana",category:"Playas",municipality:"Ferreries",lat:39.9390,lng:3.9680,
        photo:"https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1200&auto=format&fit=crop",
        desc:"Playa virgen de arena blanca; acceso a pie desde el parking.",
        obs:"Socorrista y WC solo en verano.",
        services:["‚úîÔ∏è Parking","üöª WC (verano)","‚ùå Duchas","‚ùå Restauraci√≥n","üõü Socorrista (verano)"],
        gmapQuery:"Cala Mitjana Menorca"},
      {id:"arenal",name:"Arenal d‚Äôen Castell",category:"Playas",municipality:"Es Mercadal",lat:40.0260,lng:4.1910,
        photo:"https://images.unsplash.com/photo-1526779259212-939e64788e3c?q=80&w=1200&auto=format&fit=crop",
        desc:"Gran playa semicircular y muy protegida del viento.",
        obs:"Ideal para familias; servicios completos.",
        services:["‚úîÔ∏è Parking","üöª WC","üöø Duchas","üè™ Tiendas","üçπ Restauraci√≥n","üõü Socorrista","‚ôø Accesible","üöç Bus"],
        gmapQuery:"Arenal d'en Castell"},
      {id:"tirant",name:"Cala Tirant",category:"Playas",municipality:"Fornells",lat:40.0510,lng:4.1150,
        photo:"https://images.unsplash.com/photo-1544551763-7ef420be2d4e?q=80&w=1200&auto=format&fit=crop",
        desc:"Amplia playa del norte, apreciada para deportes acu√°ticos.",
        obs:"Viento del norte puede levantar oleaje.",
        services:["‚úîÔ∏è Parking","üöª WC","üçπ Restauraci√≥n","üõü Socorrista"],
        gmapQuery:"Cala Tirant Menorca"},
      {id:"na-macaret",name:"Na Macaret",category:"Playas",municipality:"Es Mercadal",lat:40.0240,lng:4.2160,
        photo:"https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1200&auto=format&fit=crop",
        desc:"Peque√±a playa urbana con ambiente local.",
        obs:"Muy tranquila fuera de temporada.",
        services:["‚úîÔ∏è Parking","üöª WC","üçπ Bares cerca","‚ôø Accesible"],
        gmapQuery:"Na Macaret Menorca"},

      // PUEBLOS
      {id:"mao",name:"Ma√≥ (Mah√≥n)",category:"Pueblos",municipality:"Ma√≥",lat:39.8885,lng:4.2658,
        photo:"https://images.unsplash.com/photo-1512453979798-5ea266f8880c?q=80&w=1200&auto=format&fit=crop",
        desc:"Capital con puerto natural, Mercado del Claustre, Museo de Menorca y La Mola.",
        obs:"Ambiente animado y multicultural con vida nocturna en el puerto.",
        gmapQuery:"Mah√≥n Menorca"},
      {id:"ciutadella",name:"Ciutadella",category:"Pueblos",municipality:"Ciutadella",lat:40.0014,lng:3.8411,
        photo:"https://images.unsplash.com/photo-1494526585095-c41746248156?q=80&w=1200&auto=format&fit=crop",
        desc:"Antigua capital de gran car√°cter hist√≥rico y puerto pintoresco.",
        obs:"Famosa por las Fiestas de Sant Joan (23‚Äì24 de junio).",
        gmapQuery:"Ciutadella de Menorca"},
      {id:"es-castell",name:"Es Castell",category:"Pueblos",municipality:"Es Castell",lat:39.8786,lng:4.2962,
        photo:"https://images.unsplash.com/photo-1493558103817-58b2924bce98?q=80&w=1200&auto=format&fit=crop",
        desc:"Municipio m√°s oriental; trazado brit√°nico y Cales Fonts.",
        obs:"Perfecto para pasear al atardecer.",
        gmapQuery:"Cales Fonts"},
      {id:"alaior",name:"Alaior",category:"Pueblos",municipality:"Alaior",lat:39.9302,lng:4.1381,
        photo:"https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop",
        desc:"Tradici√≥n artesanal y queso Mah√≥n-Menorca. L√îAC arte contempor√°neo.",
        obs:"Casco antiguo con ambiente local.",
        gmapQuery:"Alaior"},
      {id:"es-mercadal",name:"Es Mercadal",category:"Pueblos",municipality:"Es Mercadal",lat:39.9927,lng:4.0945,
        photo:"https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1200&auto=format&fit=crop",
        desc:"A los pies del Monte Toro; gastronom√≠a y Centro Artesanal.",
        obs:"Ubicaci√≥n c√©ntrica para explorar la isla.",
        gmapQuery:"Es Mercadal"},
      {id:"ferreries",name:"Ferreries",category:"Pueblos",municipality:"Ferreries",lat:39.9831,lng:3.9374,
        photo:"https://images.unsplash.com/photo-1505764706515-aa95265c5abc?q=80&w=1200&auto=format&fit=crop",
        desc:"Artesan√≠a (avarcas). Cerca de Galdana y Mitjana.",
        obs:"Rodeado de monta√±as y naturaleza.",
        gmapQuery:"Ferreries Menorca"},
      {id:"es-migjorn",name:"Es Migjorn Gran",category:"Pueblos",municipality:"Es Migjorn Gran",lat:39.9574,lng:4.0504,
        photo:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop",
        desc:"Peque√±o, aut√©ntico y tranquilo. Acceso a Binigaus y Santo Tom√°s.",
        obs:"Buen lugar para alojarse en entorno relajado.",
        gmapQuery:"Es Migjorn Gran"},
      {id:"sant-lluis",name:"Sant Llu√≠s",category:"Pueblos",municipality:"Sant Llu√≠s",lat:39.8525,lng:4.2583,
        photo:"https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop",
        desc:"Trazado franc√©s. Mol√≠ de Dalt (etnol√≥gico). Cerca de Punta Prima y Binibeca.",
        obs:"Iglesia dedicada a San Luis.",
        gmapQuery:"Sant Llu√≠s"},
      {id:"fornells-pob",name:"Fornells (pueblo)",category:"Pueblos",municipality:"Es Mercadal",lat:40.0586,lng:4.1363,
        photo:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop",
        desc:"Pueblo marinero famoso por la caldereta y deportes n√°uticos.",
        obs:"Entorno pintoresco al norte de la isla.",
        gmapQuery:"Fornells Menorca"},

      // MIRADORES / FAROS
      {id:"faro-favaritx",name:"Faro de Fav√†ritx",category:"Miradores",municipality:"Ma√≥",lat:39.9963,lng:4.2759,
        photo:"https://images.unsplash.com/photo-1512453979798-5ea266f8880c?q=80&w=1200&auto=format&fit=crop",
        desc:"Faro sobre roca negra en s‚ÄôAlbufera des Grau; entorno de paisaje lunar.",
        obs:"Amaneceres espectaculares; acceso regulado en verano.",
        gmapQuery:"Faro de Fav√†ritx"},
      {id:"miradores-mao",name:"Miradores del puerto de Ma√≥",category:"Miradores",municipality:"Ma√≥",lat:39.8889,lng:4.2659,
        photo:"https://images.unsplash.com/photo-1512453979798-5ea266f8880c?q=80&w=1200&auto=format&fit=crop",
        desc:"Varios puntos (Basti√≥ de Sant Roc, Pont des Castell) con vistas al puerto natural.",
        obs:"Paseo al atardecer para ver la bocana y la Illa del Rei.",
        gmapQuery:"Basti√≥ de Sant Roc Ma√≥"},
      {id:"sant-esteve-mira",name:"Cala Sant Esteve ‚Äì Fuerte Marlborough",category:"Miradores",municipality:"Es Castell",lat:39.8649,lng:4.3079,
        photo:"https://images.unsplash.com/photo-1470218091926-22a08a325802?q=80&w=1200&auto=format&fit=crop",
        desc:"Enclave hist√≥rico en la entrada del puerto de Ma√≥ con fortificaciones del s. XVIII.",
        obs:"Combina paisaje costero y patrimonio; parte accesible.",
        gmapQuery:"Cala Sant Esteve Menorca"},
      {id:"monte-toro",name:"Monte Toro",category:"Miradores",municipality:"Es Mercadal",lat:39.9890,lng:4.0902,
        photo:"https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1200&auto=format&fit=crop",
        desc:"Punto m√°s alto de Menorca con vistas 360¬∫ y santuario.",
        obs:"Mejor mirador central para orientarse en la isla.",
        gmapQuery:"Monte Toro Menorca"},
      {id:"faro-cavalleria",name:"Faro de Cavalleria",category:"Miradores",municipality:"Es Mercadal",lat:40.0607,lng:4.0800,
        photo:"https://images.unsplash.com/photo-1505764706515-aa95265c5abc?q=80&w=1200&auto=format&fit=crop",
        desc:"Faro m√°s antiguo de Menorca (1857) sobre acantilados de 40 m.",
        obs:"Centro de interpretaci√≥n cercano; vistas al norte abierto.",
        gmapQuery:"Faro de Cavalleria"},
      {id:"punta-nati",name:"Punta Nati",category:"Miradores",municipality:"Ciutadella",lat:40.0618,lng:3.7948,
        photo:"https://images.unsplash.com/photo-1494526585095-c41746248156?q=80&w=1200&auto=format&fit=crop",
        desc:"Atardeceres ic√≥nicos en paisaje casi lunar.",
        obs:"Expuesto al viento; llevar abrigo al atardecer.",
        gmapQuery:"Punta Nati"},

      // CULTURA / MUSEOS / GASTRO
      {id:"naveta-tudons",name:"Naveta des Tudons",category:"Cultura",municipality:"Ciutadella",lat:40.0018,lng:3.9302,
        photo:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop",
        desc:"Monumento funerario talay√≥tico emblem√°tico (c. 1000 a.C.).",
        obs:"Parking y paneles; sin servicios.",
        gmapQuery:"Naveta des Tudons"},
      {id:"la-mola",name:"Fortaleza de La Mola",category:"Cultura",municipality:"Ma√≥",lat:39.8885,lng:4.3029,
        photo:"https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop",
        desc:"Fortaleza del s. XIX con t√∫neles y miradores.",
        obs:"Vistas espectaculares del puerto de Ma√≥.",
        gmapQuery:"Fortaleza de La Mola"},
      {id:"museo-menorca",name:"Museo de Menorca",category:"Cultura",municipality:"Ma√≥",lat:39.8890,lng:4.2650,
        photo:"https://images.unsplash.com/photo-1529679214159-c8ae9a97ae64?q=80&w=1200&auto=format&fit=crop",
        desc:"Principal museo de la isla en antiguo convento franciscano.",
        obs:"Exposiciones temporales; imprescindible para entender Menorca.",
        gmapQuery:"Museo de Menorca"},
      {id:"can-saura",name:"Can Saura (Museo Municipal)",category:"Cultura",municipality:"Ciutadella",lat:40.0007,lng:3.8396,
        photo:"https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop",
        desc:"Museo municipal en palacio hist√≥rico.",
        obs:"En pleno casco hist√≥rico de Ciutadella.",
        gmapQuery:"Can Saura Ciutadella"},
      {id:"museo-militar",name:"Museo Militar de Menorca",category:"Cultura",municipality:"Es Castell",lat:39.8779,lng:4.2943,
        photo:"https://images.unsplash.com/photo-1470218091926-22a08a325802?q=80&w=1200&auto=format&fit=crop",
        desc:"Museo en antiguos cuarteles de Cala Corb; armas, uniformes y mapas.",
        obs:"Ideal para comprender la importancia estrat√©gica de la isla.",
        gmapQuery:"Museo Militar de Menorca"},
      {id:"marlborough",name:"Fuerte Marlborough",category:"Cultura",municipality:"Es Castell",lat:39.8667,lng:4.3096,
        photo:"https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop",
        desc:"Fortaleza excavada en la roca (1720‚Äì1726) con galer√≠as y miradores.",
        obs:"Centro de visitantes; parcialmente accesible.",
        gmapQuery:"Fuerte Marlborough"},
      {id:"loac",name:"L√îAC ‚Äì Alaior Art Contemporani",category:"Cultura",municipality:"Alaior",lat:39.9338,lng:4.1406,
        photo:"https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop",
        desc:"Arte contempor√°neo en el antiguo convento de San Diego.",
        obs:"Di√°logo entre arte contempor√°neo y arquitectura hist√≥rica.",
        gmapQuery:"LOAC Alaior"},
      {id:"subaida",name:"Queser√≠a Subaida",category:"Gastronom√≠a",municipality:"Alaior",lat:39.9380,lng:4.1030,
        photo:"https://images.unsplash.com/photo-1526318472351-c75fcf070305?q=80&w=1200&auto=format&fit=crop",
        desc:"Finca de queso Mah√≥n-Menorca con visitas y catas.",
        obs:"Tienda y accesible; experiencia gastron√≥mica.",
        gmapQuery:"Formatges Subaida"},
      {id:"hauserwirth",name:"Hauser & Wirth Menorca (Illa del Rei)",category:"Cultura",municipality:"Ma√≥",lat:39.8840,lng:4.2730,
        photo:"https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop",
        desc:"Centro de arte en antiguo hospital naval rehabilitado.",
        obs:"Se accede en barco desde el puerto de Ma√≥.",
        gmapQuery:"Hauser & Wirth Menorca"},
      {id:"xoriguer",name:"Destiler√≠a Xoriguer (gin)",category:"Gastronom√≠a",municipality:"Ma√≥",lat:39.8880,lng:4.2550,
        photo:"https://images.unsplash.com/photo-1493558103817-58b2924bce98?q=80&w=1200&auto=format&fit=crop",
        desc:"F√°brica del Gin de Mah√≥n; visitas y degustaciones.",
        obs:"Icono gastron√≥mico y cultural de la isla.",
        gmapQuery:"Destiler√≠a Xoriguer"},

      // COMERCIO / MERCADOS
      {id:"claustre",name:"Mercat des Claustre",category:"Comercio",municipality:"Ma√≥",lat:39.8899,lng:4.2669,
        photo:"https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1200&auto=format&fit=crop",
        desc:"Mercado en antiguo claustro: comida y artesan√≠a.",
        obs:"Abierto Lun‚ÄìS√°b 8‚Äì21h ¬∑ Dom 8‚Äì14h (consultar cambios).",
        gmapQuery:"Mercat des Claustre Ma√≥"},
      {id:"mercat-ciutadella",name:"Mercado de Ciutadella (Pla√ßa de la Llibertat)",category:"Comercio",municipality:"Ciutadella",lat:40.0005,lng:3.8398,
        photo:"https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop",
        desc:"Mercado tradicional con producto local.",
        obs:"Artesanal nocturno en verano (consultar d√≠as).",
        gmapQuery:"Mercado de Ciutadella Plaza de la Llibertat"},
      {id:"mercat-alaior",name:"Mercado de Alaior (Pla√ßa des Ramal)",category:"Comercio",municipality:"Alaior",lat:39.9305,lng:4.1394,
        photo:"https://images.unsplash.com/photo-1493558103817-58b2924bce98?q=80&w=1200&auto=format&fit=crop",
        desc:"Mercado animado; Mercat de Nit en verano.",
        obs:"Consultar calendario municipal.",
        gmapQuery:"Mercado de Alaior Plaza des Ramal"},

      // NI√ëOS
      {id:"lloc-menorca",name:"Lloc de Menorca (zoo y naturaleza)",category:"Ni√±os",municipality:"Alaior",lat:39.9539,lng:4.1536,
        photo:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop",
        desc:"Parque con animales rescatados y zonas de juego.",
        obs:"Plan tranquilo y familiar.",
        gmapQuery:"Lloc de Menorca"},
      {id:"salbufera-centre",name:"Parque Natural s‚ÄôAlbufera des Grau ‚Äì Centro",category:"Ni√±os",municipality:"Ma√≥",lat:39.9667,lng:4.2588,
        photo:"https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop",
        desc:"Rutas sencillas, observaci√≥n de aves y naturaleza.",
        obs:"Perfecto para iniciar a los peques en el senderismo.",
        gmapQuery:"S'Albufera des Grau Centre Visitants"},

      // ACTIVIDADES
      {id:"kayak-fornells",name:"Kayak en Fornells",category:"Actividades",municipality:"Fornells",lat:40.0586,lng:4.1363,
        photo:"https://images.unsplash.com/photo-1504215680853-026ed2a45def?q=80&w=1200&auto=format&fit=crop",
        desc:"Rutas en kayak por bah√≠a protegida; ideal para iniciarse.",
        obs:"Centros de alquiler y gu√≠as en el puerto.",
        gmapQuery:"Kayak Fornells"},
      {id:"kayak-porter",name:"Kayak en Cala en Porter",category:"Actividades",municipality:"Alaior",lat:39.8746,lng:4.1310,
        photo:"https://images.unsplash.com/photo-1520975922322-cf1b25c11b5d?q=80&w=1200&auto=format&fit=crop",
        desc:"Kayak familiar entre acantilados.",
        obs:"Mar en calma recomendado para principiantes.",
        gmapQuery:"Kayak Cala en Porter"},
      {id:"barco-ciutadella",name:"Excursiones en barco ‚Äì Puerto de Ciutadella",category:"Actividades",municipality:"Ciutadella",lat:40.0058,lng:3.8401,
        photo:"https://images.unsplash.com/photo-1526318472351-c75fcf070305?q=80&w=1200&auto=format&fit=crop",
        desc:"Salidas a calas del sur; algunas con fondo de cristal.",
        obs:"Reservar en temporada alta.",
        gmapQuery:"Excursiones barco Ciutadella"},
      {id:"barco-mao",name:"Excursiones en barco ‚Äì Puerto de Ma√≥",category:"Actividades",municipality:"Ma√≥",lat:39.8868,lng:4.2695,
        photo:"https://images.unsplash.com/photo-1526779259212-939e64788e3c?q=80&w=1200&auto=format&fit=crop",
        desc:"Visitas por el puerto natural y alrededores.",
        obs:"Opci√≥n de barcos con visi√≥n submarina.",
        gmapQuery:"Boat tours Mahon"},
      {id:"cami-cavalls",name:"Cam√≠ de Cavalls ‚Äì tramo familiar (Es Grau)",category:"Actividades",municipality:"Ma√≥",lat:39.9460,lng:4.2760,
        photo:"https://images.unsplash.com/photo-1512453979798-5ea266f8880c?q=80&w=1200&auto=format&fit=crop",
        desc:"Senderismo f√°cil junto a costa y humedales.",
        obs:"Tramos sombreados y miradores de aves.",
        gmapQuery:"Cami de Cavalls Es Grau"},

      // FIESTAS
      {id:"fiesta-sant-joan",name:"Fiestas de Sant Joan",category:"Fiestas",municipality:"Ciutadella",lat:40.0017,lng:3.8395,
        photo:"https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop",
        desc:"23‚Äì24 de junio ¬∑ Jaleo y jocs des Pla en Ciutadella.",
        obs:"Fechas aproximadas seg√∫n calendario anual.",
        gmapQuery:"Pla√ßa des Born Ciutadella"},
      {id:"fiesta-sant-marti",name:"Sant Mart√≠",category:"Fiestas",municipality:"Es Mercadal",lat:39.9927,lng:4.0945,
        photo:"https://images.unsplash.com/photo-1494526585095-c41746248156?q=80&w=1200&auto=format&fit=crop",
        desc:"19‚Äì20 julio ¬∑ Jaleo y actos tradicionales.",
        obs:"Consultar programa oficial anual.",
        gmapQuery:"Es Mercadal centre"},
      {id:"fiesta-gracia",name:"Mare de D√©u de Gr√†cia",category:"Fiestas",municipality:"Ma√≥",lat:39.8899,lng:4.2658,
        photo:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop",
        desc:"7‚Äì8 septiembre ¬∑ Fiestas patronales de Ma√≥.",
        obs:"Eventos por todo el centro de Ma√≥.",
        gmapQuery:"Ma√≥ centre"},
      {id:"fiesta-sant-lluis",name:"Sant Llu√≠s",category:"Fiestas",municipality:"Sant Llu√≠s",lat:39.8525,lng:4.2583,
        photo:"https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop",
        desc:"24‚Äì25 agosto (aprox) ¬∑ Jaleo y actos festivos.",
        obs:"Fechas exactas pueden variar.",
        gmapQuery:"Sant Llu√≠s centre"},
      {id:"fiesta-es-castell",name:"Sant Jaume",category:"Fiestas",municipality:"Es Castell",lat:39.8786,lng:4.2962,
        photo:"https://images.unsplash.com/photo-1505764706515-aa95265c5abc?q=80&w=1200&auto=format&fit=crop",
        desc:"24‚Äì25 julio ¬∑ Fiestas patronales de Es Castell.",
        obs:"Eventos en plazas principales y Cales Fonts.",
        gmapQuery:"Es Castell centre"}
    ];

    const CAT_COLORS = {
      "Playas":"var(--playas)","Pueblos":"var(--pueblos)","Miradores":"var(--miradores)","Cultura":"var(--cultura)",
      "Gastronom√≠a":"var(--gastro)","Comercio":"var(--comercio)","Ni√±os":"var(--ninyos)","Actividades":"var(--actividades)","Fiestas":"var(--fiestas)","Todos":"#475569"
    };

    const $ = s => document.querySelector(s);
    const icon = (color)=> L.divIcon({
      className:"",
      iconSize:[30,30],
      html: `<div style="width:30px;height:30px;display:flex;align-items:center;justify-content:center">
              <svg viewBox="0 0 32 32" width="30" height="30" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 2C9.3 2 4 7.3 4 14c0 8.3 10.2 15.7 10.8 16.1a1 1 0 0 0 1.4 0C17.8 29.7 28 22.3 28 14 28 7.3 22.7 2 16 2Z" fill="${color}" opacity="0.95"/>
                <circle cx="16" cy="14" r="5" fill="white"/>
              </svg>
            </div>`
    });

    const muniSelect = $("#muniSelect"), qInput = $("#qInput"), resetBtn = $("#resetBtn");
    const catChips = $("#catChips"), listEl = $("#list");
    const detailImg=$("#detailImg"), detailName=$("#detailName"), detailBadge=$("#detailBadge");
    const detailMeta=$("#detailMeta"), detailDesc=$("#detailDesc"), detailServices=$("#detailServices"), detailObs=$("#detailObs");
    const detailSource=$("#detailSource"), detailMaps=$("#detailMaps"), seeInModal=$("#seeInModal");
    const summaryTitle=$("#summaryTitle"), summaryText=$("#summaryText");
    const overlay=$("#overlay"), overlayTitle=$("#overlayTitle"), overlayFrame=$("#overlayFrame");
    const locateBtn=$("#locateBtn"), radiusInput=$("#radiusInput"), radiusLabel=$("#radiusLabel"), sortByDistance=$("#sortByDistance");

    let map, clusterGroup;
    const markerMap = new Map(); // id -> marker
    let state = {cat:"Todos", muni:"Todos", q:"", userPos:null, radiusKm: Number(radiusInput.value)};
    let userCircle = null;

    function kmDistance(a,b){
      if(!a||!b) return Infinity;
      const R=6371, dLat=(b[0]-a[0])*Math.PI/180, dLon=(b[1]-a[1])*Math.PI/180;
      const la=a[0]*Math.PI/180, lb=b[0]*Math.PI/180;
      const x=Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(x));
    }

    function initMap(){
      map = L.map("map",{ zoomControl:true, maxZoom: 19 }).setView([39.95,4.06],10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);
      clusterGroup = L.markerClusterGroup({showCoverageOnHover:false, spiderfyOnMaxZoom:true});
      map.addLayer(clusterGroup);
      renderFilters(); renderAll();
    }

    function renderFilters(){
      const cats = ["Todos","Playas","Pueblos","Miradores","Cultura","Gastronom√≠a","Comercio","Ni√±os","Actividades","Fiestas"];
      catChips.innerHTML = cats.map(c=>`<button class="chip ${state.cat===c?"active":""}" data-cat="${c}">${c}</button>`).join("");
      catChips.querySelectorAll(".chip").forEach(btn=>{
        btn.onclick = ()=>{ state.cat = btn.dataset.cat; updateSummary(); renderAll(); };
      });
      updateSummary();
    }

    function updateSummary(){
      summaryTitle.textContent = state.cat;
      summaryText.textContent = CATEGORY_COPY[state.cat] || "";
      detailBadge.textContent = state.cat;
      detailBadge.className = `badge b-${state.cat}`;
    }

    function currentDataRaw(){
      const base = (state.cat==="Todos") ? PLACES : PLACES.filter(p => p.category===state.cat);
      return base.filter(p =>
        (state.muni==="Todos" || p.municipality===state.muni) &&
        ((state.q||"").trim()==="" || (p.name+" "+p.municipality+" "+p.category).toLowerCase().includes(state.q.toLowerCase()))
      );
    }

    function currentData(){
      let data = currentDataRaw().slice();
      if(state.userPos){
        data.forEach(p=>{ p.__dist = (p.lat && p.lng) ? kmDistance(state.userPos,[p.lat,p.lng]) : Infinity; });
        if (sortByDistance.checked) data.sort((a,b)=>(a.__dist||Infinity)-(b.__dist||Infinity));
      }
      return data;
    }

    function setDetail(p){
      detailImg.src = p.photo || "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop";
      detailName.textContent = p.name;
      detailBadge.textContent = p.category;
      detailBadge.className = `badge b-${p.category}`;
      const dist = (state.userPos && p.__dist && isFinite(p.__dist)) ? ` ¬∑ a ${p.__dist.toFixed(1)} km` : "";
      detailMeta.textContent = `${p.municipality} ¬∑ ${p.category}${dist}`;
      detailDesc.textContent = p.desc || "Descripci√≥n pendiente.";
      if (p.category==="Playas" && Array.isArray(p.services)) {
        detailServices.innerHTML = p.services.map(s=>`<span>${s}</span>`).join("");
      } else {
        detailServices.innerHTML = "";
      }
      detailObs.textContent = p.obs ? `Observaciones: ${p.obs}` : "";
      const q = encodeURIComponent(p.gmapQuery || `${p.name} ${p.municipality} Menorca`);
      const gmapsUrl = p.gmapUrl || `https://www.google.com/maps/search/?api=1&query=${q}`;
      detailSource.href = p.sourceUrl || "#";
      detailMaps.href = gmapsUrl;
      seeInModal.onclick = ()=>{
        overlayTitle.textContent = p.name;
        overlayFrame.src = p.gmapUrl || `https://www.google.com/maps?q=${q}&output=embed`;
        overlay.classList.add("active");
      };

      if(p.lat && p.lng){
        // Enfoca con desplazamiento y, al terminar, abre el popup del marker
        flyToWithOffset([p.lat, p.lng], FOCUS_ZOOM);
        const m = markerMap.get(p.id);
        if (m) {
          map.once('moveend', ()=> m.openPopup());
        }
      }
    }

    function renderList(){
      const data = currentData();
      listEl.innerHTML = data.map((p,i)=>{
        const color = CAT_COLORS[p.category] || "#475569";
        const q = encodeURIComponent(p.gmapQuery || `${p.name} ${p.municipality} Menorca`);
        const dist = (state.userPos && p.__dist && isFinite(p.__dist)) ? `<span class="muted"> ¬∑ ${p.__dist.toFixed(1)} km</span>` : "";
        return `
          <article class="card" onclick="window.__pick(${i})" aria-label="${p.name} en ${p.municipality}">
            <img class="thumb" alt="Foto de ${p.name}" src="${p.photo || ""}">
            <div style="display:flex;gap:10px;align-items:flex-start;flex:1">
              <div class="dot" style="color:${color}">‚óè</div>
              <div>
                <div class="title">${p.name}${dist}</div>
                <div class="muted">${p.municipality} ¬∑ <span class="badge b-${p.category}">${p.category}</span></div>
                <div class="mini">
                  <a href="https://www.google.com/maps/search/?api=1&query=${q}" target="_blank" rel="noreferrer">Maps</a>
                  <span class="link" onclick="event.stopPropagation();window.__pick(${i})">Ver aqu√≠</span>
                </div>
              </div>
            </div>
          </article>`;
      }).join("") || `<p class="muted">No hay resultados con esos filtros.</p>`;
    }

    async function renderMarkers(){
      const data = currentData();
      clusterGroup.clearLayers();
      markerMap.clear();

      const tasks = data.map(async (p,i)=>{
        if (p.lat && p.lng){
          const m = L.marker([p.lat,p.lng], {icon:icon(CAT_COLORS[p.category]||"#475569")});
          m.on("click", ()=> window.__pick(i));
          const q = encodeURIComponent(p.gmapQuery || `${p.name} ${p.municipality} Menorca`);
          const dist = (state.userPos && p.__dist && isFinite(p.__dist)) ? ` ¬∑ ${p.__dist.toFixed(1)} km` : "";
          m.bindPopup(`<strong>${p.name}</strong>${dist}<br><span style="font-size:12px;color:#64748b">${p.municipality} ¬∑ ${p.category}</span><br><a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${q}">Ver en Google Maps</a>`);
          clusterGroup.addLayer(m);
          markerMap.set(p.id, m);
        }
      });

      await Promise.allSettled(tasks);

      const grpBounds = clusterGroup.getBounds();
      if (grpBounds && grpBounds.isValid()) map.fitBounds(grpBounds, {padding:[20,20]});

      if (userCircle) { map.removeLayer(userCircle); userCircle=null; }
      if (state.userPos){
        userCircle = L.circle(state.userPos, {radius: state.radiusKm*1000, color:'#0ea5e9', weight:1, fillOpacity:0.06});
        userCircle.addTo(map);
      }
    }

    window.__pick = function(i){
      const data = currentData();
      const p = data[i]; if(!p) return;
      setDetail(p);
    };

    async function renderAll(){
      const raw = currentDataRaw();
      if (state.userPos){
        raw.forEach(p=>{ p.__dist = (p.lat && p.lng) ? kmDistance(state.userPos,[p.lat,p.lng]) : Infinity; });
      }
      renderList();
      await renderMarkers();
      const d = currentData();
      if(d[0]) setDetail(d[0]);
    }

    const muniSelectEl = $("#muniSelect");
    muniSelectEl.onchange = e => { state.muni = e.target.value; renderAll(); };
    qInput.oninput = e => { state.q = e.target.value; renderAll(); };
    resetBtn.onclick = ()=>{
      state={cat:"Todos",muni:"Todos",q:"",userPos:null,radiusKm:Number(radiusInput.value)};
      muniSelectEl.value="Todos"; qInput.value="";
      sortByDistance.checked=false;
      if (userCircle){ map.removeLayer(userCircle); userCircle=null; }
      renderFilters(); renderAll();
    };

    const locateBtnEl = document.getElementById('locateBtn');
    locateBtnEl.onclick = ()=>{
      if (!navigator.geolocation) { alert("La geolocalizaci√≥n no est√° disponible en este dispositivo."); return; }
      locateBtnEl.disabled = true;
      navigator.geolocation.getCurrentPosition(pos=>{
        state.userPos = [pos.coords.latitude, pos.coords.longitude];
        locateBtnEl.disabled = false;
        renderAll().then(()=>{ if (state.userPos) map.flyTo(state.userPos, 12, {duration:.7}); });
      }, err=>{
        locateBtnEl.disabled = false;
        alert("No se pudo obtener la ubicaci√≥n. Revisa permisos del navegador.");
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
    };

    const radiusInputEl = document.getElementById('radiusInput');
    const radiusLabelEl = document.getElementById('radiusLabel');
    radiusInputEl.oninput = (e)=>{
      state.radiusKm = Number(e.target.value);
      radiusLabelEl.textContent = `${state.radiusKm} km`;
      renderAll();
    };
    sortByDistance.onchange = ()=> renderAll();

    initMap();
  </script>
</body>
</html>
